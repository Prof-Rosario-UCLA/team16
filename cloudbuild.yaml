steps:
  - name: "gcr.io/cloud-builders/docker"
    entrypoint: "bash"
    args: ["-c", "docker login --username=$$USERNAME --password=$$PASSWORD"]
    secretEnv: ["USERNAME", "PASSWORD"]

  - name: "gcr.io/cloud-builders/docker"
    entrypoint: "bash"
    args: ["-c", "docker build -t $$USERNAME/doodly-repo:latest backend"]
    secretEnv: ["USERNAME"]

  - name: "gcr.io/cloud-builders/docker"
    entrypoint: "bash"
    args: ["-c", "docker push $$USERNAME/doodly-repo:latest"]
    secretEnv: ["USERNAME"]

  - name: "gcr.io/cloud-builders/kubectl"
    env:
      - "CLOUDSDK_COMPUTE_REGION=us-west1-b"
      - "CLOUDSDK_CONTAINER_CLUSTER=doodly-cluster"
    args: ["apply", "-f", "backend/k8s/"]

availableSecrets:
  secretManager:
    - versionName: projects/cs144-25s-team16/secrets/docker-password/versions/1
      env: "PASSWORD"
    - versionName: projects/cs144-25s-team16/secrets/docker-username/versions/1
      env: "USERNAME"

images:
  - "ghtjason/doodly-repo:latest"

options:
  logging: CLOUD_LOGGING_ONLY
